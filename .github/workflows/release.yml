name: Release Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-release:
    name: Build & Release Sentinel Binary
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-release-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      # -------------------------------
      # Checkout source code
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Force branch to workflow SHA
        run: git reset --hard ${{ github.sha }}

      # -------------------------------
      # Semantic Release (version bump, changelog, tagging)
      # -------------------------------
      - name: Semantic Release
        id: semantic-release
        uses: python-semantic-release/python-semantic-release@v10.3.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          git_committer_name: "github-actions"
          git_committer_email: "actions@users.noreply.github.com"
          verbosity: 2

      # -------------------------------
      # Cache ccache across builds
      # -------------------------------
      - name: Cache ccache
        if: steps.semantic-release.outputs.released == 'true'
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-${{ github.ref_name }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      # -------------------------------
      # Build binary inside manylinux container
      # -------------------------------
      - name: Build binary with Nuitka (manylinux_2_28, Python 3.12)
        if: steps.semantic-release.outputs.released == 'true'
        uses: addnab/docker-run-action@v3
        with:
          image: quay.io/pypa/manylinux_2_28_x86_64
          options: >
            -v ${{ github.workspace }}:/workspace
            -v ${{ github.workspace }}/.ccache:/root/.ccache
          run: |
            # Install ccache inside container
            yum install -y ccache

            # Unpack static libpython (required for Nuitka embedding)
            cd /opt/_internal
            tar xf static-libs-for-embedding-only.tar.xz

            # Setup Python 3.12 virtualenv
            cd /workspace
            /opt/python/cp312-cp312/bin/python -m venv venv
            source venv/bin/activate

            # Install build tools + app dependencies
            pip install --upgrade pip setuptools wheel nuitka
            pip install -r requirements.txt

            # Configure ccache
            export PATH="/usr/lib64/ccache:$PATH"
            ccache --max-size=2G
            echo ">>> ccache stats before build:"
            ccache --show-stats

            # Build binary with Nuitka
            VERSION=${{ steps.semantic-release.outputs.version }}
            BASENAME="sentinel-linux-x86_64-${VERSION}"
            echo ">>> Building Sentinel version $VERSION -> $BASENAME"

            python -m nuitka \
              --onefile \
              --standalone \
              --lto=yes \
              --static-libpython=yes \
              --output-filename=$BASENAME \
              sentinel.py

            chmod +x $BASENAME
            mkdir -p dist
            mv $BASENAME dist/
            ls -lh dist/

            echo ">>> ccache stats after build:"
            ccache --show-stats

      # -------------------------------
      # Smoke test binary inside container
      # -------------------------------
      - name: Smoke test built binary
        if: steps.semantic-release.outputs.released == 'true'
        uses: addnab/docker-run-action@v3
        with:
          image: quay.io/pypa/manylinux_2_28_x86_64
          options: -v ${{ github.workspace }}:/workspace
          run: |
            cd /workspace/dist
            echo ">>> Running smoke test..."
            ./sentinel-linux-x86_64-* --help || (echo "‚ùå Binary failed to run" && exit 1)

      # -------------------------------
      # Publish binary to GitHub Release
      # -------------------------------
      - name: Publish binary to GitHub Release
        if: steps.semantic-release.outputs.released == 'true'
        uses: python-semantic-release/publish-action@v10.3.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.semantic-release.outputs.tag }}