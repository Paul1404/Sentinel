name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-release-${{ github.ref_name }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Force branch to workflow sha
        run: git reset --hard ${{ github.sha }}

      - name: Semantic Release
        id: release
        uses: python-semantic-release/python-semantic-release@v10.3.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          git_committer_name: "github-actions"
          git_committer_email: "actions@users.noreply.github.com"
          verbosity: 2

      - name: Build binary with Nuitka (manylinux_2_28, Python 3.12)
        if: steps.release.outputs.released == 'true'
        uses: addnab/docker-run-action@v3
        with:
          image: quay.io/pypa/manylinux_2_28_x86_64
          options: -v ${{ github.workspace }}:/workspace
          run: |
            cd /opt/_internal
            tar xf static-libs-for-embedding-only.tar.xz

            cd /workspace
            /opt/python/cp312-cp312/bin/python -m venv venv
            source venv/bin/activate

            # Install build tools + app dependencies
            pip install --upgrade pip setuptools wheel nuitka
            pip install -r requirements.txt 

            VERSION=${{ steps.release.outputs.version }}
            BASENAME="sentinel-linux-x86_64-${VERSION}"
            echo "Building Sentinel version $VERSION -> $BASENAME"

            python -m nuitka \
              --onefile \
              --standalone \
              --lto=yes \
              --static-libpython=yes \
              --output-filename=$BASENAME \
              sentinel.py

            mkdir -p dist
            mv $BASENAME dist/
            ls -lh dist/

      - name: Smoke test built binary
        if: steps.release.outputs.released == 'true'
        run: |
          chmod +x dist/sentinel-linux-x86_64-*
          echo "Running smoke test..."
          ./dist/sentinel-linux-x86_64-* --help || (echo "‚ùå Binary failed to run" && exit 1)

      - name: Publish binary to GitHub Release
        if: steps.release.outputs.released == 'true'
        uses: python-semantic-release/publish-action@v10.3.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.release.outputs.tag }}